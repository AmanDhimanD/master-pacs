function loadTemplate(e,t){$.get(e,function(e){var o=$.parseHTML(e);$.each(o,function(e,o){if("DIV"===o.nodeName){var n=$(o);t(n)}})})}function displayThumbnail(e,t,o,n,a){$(e).find("a").each(function(){$(this).removeClass("active")}),$(t).addClass("active"),cornerstone.getEnabledElement(o).image&&(cornerstoneTools.stopClip(o),cornerstoneTools.stackScroll.disable(o),cornerstoneTools.stackScroll.enable(o)),cornerstone.loadAndCacheImage(n.imageIds[0]).then(function(e){a&&a.call(e,o,n);var t=cornerstoneTools.getToolState(o,"stack");t.data[0]=n,t.data[0].currentImageIdIndex=0;var s=cornerstone.getDefaultViewport(o,e);cornerstone.displayImage(o,e,s),cornerstone.fitToWindow(o),cornerstoneTools.stackPrefetch.enable(o),void 0!==n.frameRate&&cornerstoneTools.playClip(o,n.frameRate)})}function forEachViewport(e){var t=$(".viewport");$.each(t,function(t,o){var n=o;try{e(n)}catch(e){}})}function disableAllTools(){forEachViewport(function(e){cornerstoneTools.magnify.deactivate(e),cornerstoneTools.wwwc.disable(e),cornerstoneTools.pan.activate(e,2),cornerstoneTools.zoom.activate(e,4),cornerstoneTools.probe.deactivate(e,1),cornerstoneTools.length.deactivate(e,1),cornerstoneTools.angle.deactivate(e,1),cornerstoneTools.ellipticalRoi.deactivate(e,1),cornerstoneTools.rectangleRoi.deactivate(e,1),cornerstoneTools.stackScroll.deactivate(e,1),cornerstoneTools.wwwcTouchDrag.deactivate(e),cornerstoneTools.zoomTouchDrag.deactivate(e),cornerstoneTools.panTouchDrag.deactivate(e),cornerstoneTools.stackScrollTouchDrag.deactivate(e)})}function setupButtons(e){$(".button-tool-ww").on("click touchstart",function(){disableAllTools(),forEachViewport(function(e){cornerstoneTools.wwwc.activate(e,1),cornerstoneTools.wwwcTouchDrag.activate(e)})}),$(".button-tool-invert").on("click touchstart",function(){disableAllTools(),forEachViewport(function(e){var t=cornerstone.getViewport(e);!0===t.invert?t.invert=!1:t.invert=!0,cornerstone.setViewport(e,t)})}),$(".button-tool-zoom").on("click touchstart",function(){disableAllTools(),forEachViewport(function(e){cornerstoneTools.zoom.activate(e,5),cornerstoneTools.zoomTouchDrag.activate(e)})}),$(".button-tool-pan").on("click touchstart",function(){disableAllTools(),forEachViewport(function(e){cornerstoneTools.pan.activate(e,3),cornerstoneTools.panTouchDrag.activate(e)})}),$(".button-tool-rotateleft").on("click touchstart",function(){disableAllTools(),forEachViewport(function(e){var t=cornerstone.getViewport(e);t.rotation-=90,360===t.rotation&&(t.rotation=t.rotation+360),cornerstone.setViewport(e,t)})}),$(".button-tool-rotateright").on("click touchstart",function(){disableAllTools(),forEachViewport(function(e){var t=cornerstone.getViewport(e);t.rotation+=90,360===t.rotation&&(t.rotation=t.rotation-360),cornerstone.setViewport(e,t)})}),$(".button-tool-magnifier").on("click touchstart",function(){disableAllTools(),forEachViewport(function(e){cornerstoneTools.magnify.activate(e,1)})}),$(".button-tool-fliphorizontal").on("click touchstart",function(){disableAllTools(),forEachViewport(function(e){var t=cornerstone.getViewport(e);t.hflip+=1,1===t.hflip&&(t.hflip=-1),cornerstone.setViewport(e,t)})}),$(".button-tool-flipvertical").on("click touchstart",function(){disableAllTools(),forEachViewport(function(e){var t=cornerstone.getViewport(e);t.vflip+=1,1===t.vflip&&(t.vflip=-1),cornerstone.setViewport(e,t)})}),$(".button-tool-stack").on("click touchstart",function(){disableAllTools(),forEachViewport(function(e){cornerstoneTools.stackScroll.activate(e,1),cornerstoneTools.stackScrollTouchDrag.activate(e)})}),$(".button-tool-measure").on("click touchstart",function(){disableAllTools(),forEachViewport(function(e){cornerstoneTools.length.activate(e,1)})}),$(".button-tool-angle").on("click touchstart",function(){disableAllTools(),forEachViewport(function(e){cornerstoneTools.angle.activate(e,1)})}),$(".button-tool-hu").on("click touchstart",function(){disableAllTools(),forEachViewport(function(e){cornerstoneTools.probe.activate(e,1)})}),$(".button-tool-ellipse").on("click touchstart",function(){disableAllTools(),forEachViewport(function(e){cornerstoneTools.ellipticalRoi.activate(e,1)})}),$(".button-tool-rectangle").on("click touchstart",function(){disableAllTools(),forEachViewport(function(e){cornerstoneTools.rectangleRoi.activate(e,1)})})}function setupViewport(e,t,o){cornerstone.displayImage(e,o),void 0!==t.frameRate&&cornerstone.playClip(e,t.frameRate),cornerstoneTools.mouseInput.enable(e),cornerstoneTools.mouseWheelInput.enable(e),cornerstoneTools.touchInput.enable(e),cornerstoneTools.wwwc.activate(e,1),cornerstoneTools.pan.activate(e,2),cornerstoneTools.zoom.activate(e,4),cornerstoneTools.probe.enable(e),cornerstoneTools.length.enable(e),cornerstoneTools.ellipticalRoi.enable(e),cornerstoneTools.rectangleRoi.enable(e),cornerstoneTools.wwwcTouchDrag.activate(e),cornerstoneTools.zoomTouchPinch.activate(e),cornerstoneTools.addStackStateManager(e,["playClip"]),cornerstoneTools.addToolState(e,"stack",t),cornerstoneTools.stackScrollWheel.activate(e),cornerstoneTools.stackPrefetch.enable(e)}function setupViewportOverlays(e,t){var o=$(e).parent(),n=$(o).find(".overlay"),a=$(n[0]).find("div"),s=$(n[1]).find("div"),i=$(n[2]).find("div"),r=$(n[3]).find("div");$(a[0]).text(t.patientName),$(a[1]).text(t.patientId),$(s[0]).text(t.studyDescription),$(s[1]).text(t.studyDate),$(e).on("CornerstoneNewImage",function(t,o){var n=cornerstoneTools.getToolState(e,"playClip");void 0!==n&&n.data.length>0&&void 0!==n.data[0].intervalId&&void 0!==o.frameRate?($(i[0]).text("FPS: "+Math.round(o.frameRate)),console.log("frameRate: "+t.frameRate)):$(i[0]).text().length>0&&$(i[0]).text("");var a=cornerstoneTools.getToolState(e,"stack");if(void 0!==a&&void 0!==a.data&&0!==a.data.length){var s=a.data[0];$(i[2]).text("Image # "+(s.currentImageIdIndex+1)+"/"+s.imageIds.length)}}),$(e).on("CornerstoneImageRendered",function(e,t){$(r[0]).text("Zoom:"+t.viewport.scale.toFixed(2)),$(r[1]).text("WW/WL:"+Math.round(t.viewport.voi.windowWidth)+"/"+Math.round(t.viewport.voi.windowCenter))})}var imageViewer;function loadStudy(e,t,o,n){function a(){imageViewer.forEachElement(function(e){cornerstone.enable(e),$(e).droppable({drop:function(e,t){var o=$(t.draggable.context).data("stack");r($(this).data("index"),o)}})})}var s,i;function r(e,t){imageViewer.stacks[t].imageIds[0];var o=imageViewer.getElement(e);$(o).data("waiting")&&(imageViewer.viewports[e].find(".overlay-text").remove(),$(o).data("waiting",!1)),$(o).data("useStack",t),displayThumbnail(s,$(s).find(".series-body")[t],o,imageViewer.stacks[t],function(e,t){$(e).data("setup")||(setupViewport(e,t,this),setupViewportOverlays(e,n),$(e).data("setup",!0))})}(imageViewer=new ImageViewer(e,t)).setLayout("1x1"),i=0,n.seriesList.forEach(function(e){var t={seriesDescription:e.seriesDescription,stackId:e.seriesNumber,imageIds:[],seriesIndex:i,currentImageIdIndex:0,frameRate:e.frameRate};if(void 0!==e.numberOfFrames)for(var o=e.numberOfFrames,n=0;n<o;n++){var a=e.instanceList[0].imageId+"?frame="+n;/*("http"||"https")!==a.substr(0,4)&&(a="dicomweb://"+window.imageUrlProxy+a)*/a="dicomweb:"+window.imageUrlProxy+a,t.imageIds.push(a)}else e.instanceList.forEach(function(e){var o=e.imageId;/*("http"||"https")!==e.imageId.substr(0,4)&&(o="dicomweb://"+window.imageUrlProxy+e.imageId)*/o="dicomweb:"+window.imageUrlProxy+e.imageId,t.imageIds.push(o)});i++,imageViewer.stacks.push(t)}),a(),function(){s=$(".thumbnails-study-body");var e=0;imageViewer.stacks.forEach(function(t,o){var n=`<div class="series-body" oncontextmenu='on' unselectable='on' onselectstart='return false' onmousedown='return false'>\n            <div\n              class="series-header"\n              title="Drag and drop to preload series"\n              draggable="true" oncontextmenu='on' unselectable='on' onselectstart='return false' onmousedown='return false'\n            >\n              <div class="series-header-text">\n                \x3c!--<span class="modality-name">{stack.modality}</span>--\x3e\n                <span class="series-header-description">${t.seriesDescription}</span>\n              </div>\n              <progress\n                class="series-progress-bar"\n                value="-1"\n                max="100"\n                min="0"\n                style="display: none"\n              ></progress>\n            </div>\n            <div class="series-body-thumbs">\n              <div class="thumbnails-container" style="overflow:hidden;">\n                <div\n                  style="\n                    display: grid;\n                    grid-template-columns: repeat(auto-fill, 102px);\n                    grid-auto-rows: 102px;\n                  "\n                >\n                  <div\n                    class="instance-thumbnail"\n                    onclick=""\n                    draggable="true" oncontextmenu='on' unselectable='on' onselectstart='return false' onmousedown='return false'\n                    style="\n                      width: 100px;\n                      height: 100px;">\n                    <div class="instance-thumbnail-decorator active-container-thumbnail" style="position:absolute;">\n                      <span class="instance-no">${e+1}</span>\n                    </div>\n                  </div>\n                  \n                </div>\n              </div>\n            </div>\n          </div>`;e++;var a=$(n).appendTo(s),i=$(a).find(".instance-thumbnail")[0];cornerstone.enable(i),cornerstone.loadAndCacheImage(imageViewer.stacks[t.seriesIndex].imageIds[0]).then(function(e){0===t.seriesIndex&&$(a).addClass("active"),cornerstone.displayImage(i,e),$(a).draggable({helper:"clone"})}),$(a).on("click touchstart",function(){r(0,o)}).data("stack",o)})}(),setupButtons(e),imageViewer.isSingle()&&r(0,0)}function loadStudy1(e,t,o){$.getJSON("studies/"+o,function(o){var n=new ImageViewer(e,t);function a(){n.forEachElement(function(e){cornerstone.enable(e),$(e).droppable({drop:function(e,t){var o=$(t.draggable.context).data("stack");d($(this).data("index"),o)}})})}n.setLayout("1x1"),setupButtons(e),$(e).find(".choose-layout a").click(function(){var e=[];n.forEachElement(function(t,o,n){isNaN($(t).data("useStack"))||e.push($(t).data("useStack"))});var t=$(this).text();if(n.setLayout(t),a(),u(),e.length>0){e=e.slice(0,n.viewports.length);var o=0;e.forEach(function(e){d(o++,e)})}});var s=0;o.seriesList.forEach(function(e){var t={seriesDescription:e.seriesDescription,stackId:e.seriesNumber,imageIds:[],seriesIndex:s,currentImageIdIndex:0,frameRate:e.frameRate};if(void 0!==e.numberOfFrames)for(var o=e.numberOfFrames,a=0;a<o;a++){var i=e.instanceList[0].imageId+"?frame="+a;"http"!==i.substr(0,4)&&(i="dicomweb://localhost:8080/images/"+i),t.imageIds.push(i)}else e.instanceList.forEach(function(e){var o=e.imageId;"http"!==e.imageId.substr(0,4)&&(o="dicomweb://localhost:8080/images/"+e.imageId),t.imageIds.push(o)});s++,n.stacks.push(t)});var i=$(e).find(".imageViewer")[0],r=($(i).find(".viewportWrapper")[0],$(e).find(".viewer")[0]),c=$(e).find(".studyRow")[0];$(c).width(),$(e).find(".viewport")[0];a();var l=$(e).find(".thumbnails")[0];function d(e,t){n.stacks[t].imageIds[0];var a=n.getElement(e);$(a).data("waiting")&&(n.viewports[e].find(".overlay-text").remove(),$(a).data("waiting",!1)),$(a).data("useStack",t),displayThumbnail(l,$(l).find(".list-group-item")[t],a,n.stacks[t],function(e,t){$(e).data("setup")||(setupViewport(e,t,this),setupViewportOverlays(e,o),$(e).data("setup",!0))})}function u(){var t=$(e).find(".studyContainer")[0],o=($(t).height(),$(t).width());console.log($(t).innerWidth(),$(t).outerWidth(),$(t).width()),$(l).height("100%"),$(r).width(o-$(e).find(".thumbnailSelector:eq(0)").width()),$(r).css({height:"100%"}),$(i).css({height:$(r).height()-$(r).find(".text-center:eq(0)").height()}),n.forEachElement(function(e,t){if(cornerstone.resize(e,!0),$(e).data("waiting")){var o=t.find(".overlay-text");o.length<1&&(o=$('<div class="overlay overlay-text">Please drag a stack onto here to view images.</div>').appendTo(t));var n=t.width()/2,a=t.height()/2;o.css({top:a,left:n-o.width()/2})}})}n.stacks.forEach(function(e,t){var o='<a class="list-group-item" + oncontextmenu="return false"unselectable="on"onselectstart="return false;"onmousedown="return false;"><div class="csthumbnail"oncontextmenu="return false"unselectable="on"onselectstart="return false;"onmousedown="return false;"></div><div class=\'text-center small\'>'+e.seriesDescription+"</div></a>",a=$(o).appendTo(l),s=$(a).find("div")[0];cornerstone.enable(s),cornerstone.loadAndCacheImage(n.stacks[e.seriesIndex].imageIds[0]).then(function(t){0===e.seriesIndex&&$(a).addClass("active"),cornerstone.displayImage(s,t),$(a).draggable({helper:"clone"})}),$(a).on("click touchstart",function(){d(0,t)}).data("stack",t)}),$(window).resize(function(){u()}),u(),n.isSingle()&&d(0,0)})}function loadStudyVui(e,t,o){$.getJSON("studies/"+o+".json",function(o){var n=new ImageViewer(e,t);function a(){n.forEachElement(function(e){cornerstone.enable(e),$(e).droppable({drop:function(e,t){var o=$(t.draggable.context).data("stack");d($(this).data("index"),o)}})})}n.setLayout("1x1",!0),setupButtons(e),$(e).find(".choose-layout a").click(function(){var e=[];n.forEachElement(function(t,o,n){isNaN($(t).data("useStack"))||e.push($(t).data("useStack"))});var t=$(this).text();if(n.setLayout(t,!0),a(),u(),e.length>0){e=e.slice(0,n.viewports.length);var o=0;e.forEach(function(e){d(o++,e)})}});var s=0;o.seriesList.forEach(function(e){var t={seriesDescription:e.seriesDescription,stackId:e.seriesNumber,imageIds:[],seriesIndex:s,currentImageIdIndex:0,frameRate:e.frameRate};if(void 0!==e.numberOfFrames)for(var o=e.numberOfFrames,a=0;a<o;a++){var i=e.instanceList[0].imageId+"?frame="+a;"http"!==i.substr(0,4)&&(i="dicomweb://localhost:8080/images/"+i),t.imageIds.push(i)}else e.instanceList.forEach(function(e){var o=e.imageId;"http"!==e.imageId.substr(0,4)&&(o="dicomweb://localhost:8080/images/"+e.imageId),t.imageIds.push(o)});s++,n.stacks.push(t)});var i=$(e).find(".imageViewer")[0],r=($(i).find(".viewportWrapper")[0],$(e).find(".viewer")[0],$(e).find(".studyRow")[0]);$(r).width(),$(e).find(".viewport")[0];a();var c=$(e).find(".thumbnails-study-body")[0],l=0;function d(e,t){n.stacks[t].imageIds[0];var a=n.getElement(e);$(a).data("waiting")&&(n.viewports[e].find(".overlay-text").remove(),$(a).data("waiting",!1)),$(a).data("useStack",t),displayThumbnail(c,$(c).find(".list-group-item")[t],a,n.stacks[t],function(e,t){$(e).data("setup")||(setupViewport(e,t,this),setupViewportOverlays(e,o),$(e).data("setup",!0))})}function u(){n.forEachElement(function(e,t){if(cornerstone.resize(e,!0),$(e).data("waiting")){var o=t.find(".overlay-text");o.length<1&&(o=$('<div class="overlay overlay-text">Please drag a stack onto here to view images.</div>').appendTo(t));var n=t.width()/2,a=t.height()/2;o.css({top:a,left:n-o.width()/2})}})}n.stacks.forEach(function(e,t){var o=`<div class="series-body list-group-item" oncontextmenu='on' unselectable='on' onselectstart='return false' onmousedown='return false'>\n            <div\n              class="series-header"\n              title="Drag and drop to preload series"\n              draggable="true" oncontextmenu='on' unselectable='on' onselectstart='return false' onmousedown='return false'\n            >\n              <div class="series-header-text">\n                \x3c!--<span class="modality-name">{stack.modality}</span>--\x3e\n                <span class="series-header-description">${e.seriesDescription}</span>\n              </div>\n              <progress\n                class="series-progress-bar"\n                value="-1"\n                max="100"\n                min="0"\n                style="display: none"\n              ></progress>\n            </div>\n            <div class="series-body-thumbs">\n              <div class="thumbnails-container" style="overflow:hidden;">\n                <div\n                  style="\n                    display: grid;\n                    grid-template-columns: repeat(auto-fill, 102px);\n                    grid-auto-rows: 102px;\n                  "\n                >\n                  <div\n                    class="instance-thumbnail"\n                    onclick=""\n                    draggable="true" oncontextmenu='on' unselectable='on' onselectstart='return false' onmousedown='return false'\n                    style="\n                      width: 100px;\n                      height: 100px;">\n                    <div class="instance-thumbnail-decorator active-container-thumbnail" style="position:absolute;">\n                      <span class="instance-no">${l+1}</span>\n                    </div>\n                  </div>\n                  \n                </div>\n              </div>\n            </div>\n          </div>`;l++;var a=$(o).appendTo(c),s=$(a).find(".instance-thumbnail")[0];cornerstone.enable(s),cornerstone.loadAndCacheImage(n.stacks[e.seriesIndex].imageIds[0]).then(function(t){0===e.seriesIndex&&$(a).addClass("active"),cornerstone.displayImage(s,t),$(a).draggable({helper:"clone"})}),$(a).on("click touchstart",function(){d(0,t)}).data("stack",t)}),$(window).resize(function(){u()}),u(),n.isSingle()&&d(0,0)})}ImageViewer=function(e,t){var o=this;o.root=e,o.stacks=[],o.viewports=[],o.layout="1x1",o.viewportModel=t,o.setLayout=function(e){o.layout=e;var t=o.getRowsCols(),n=t[0],a=t[1],s=100/a,i=100/n;o.root.find(".imageViewerContainer").html("");o.viewports=[];for(var r=0;r<n;r++)for(var c=0;c<a;c++){var l=c*s+"%",d=r*i+"%",u=o.viewportModel.clone().css({width:s+"%",height:i+"%",left:l,top:d}).appendTo(o.root.find(".imageViewerContainer"));u.find(".viewport").data("index",0).data("waiting",!0),o.viewports.push(u)}},o.getRowsCols=function(){var e=o.layout.split(/x/);return[parseInt(e[0]),parseInt(e[1])]},o.isSingle=function(){return"1x1"==o.layout},o.getElement=function(e){return o.viewports[e].find(".viewport")[0]},o.forEachElement=function(e){o.viewports.forEach(function(t,n){e.call(o,t.find(".viewport")[0],t,n)})}};